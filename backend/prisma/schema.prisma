generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  EVZONE_ADMIN
  EVZONE_OPERATOR
  EVZONE_OWNER
  EVZONE_SITE_OWNER
  EVZONE_TECH
  EVZONE_DRIVER
  EVZONE_FLEET_MANAGER
}

enum StationStatus {
  ONLINE
  DEGRADED
  OFFLINE
  MAINTENANCE
}

enum StationType {
  CHARGE
  SWAP
  BOTH
}

enum SessionStatus {
  PENDING
  ACTIVE
  COMPLETED
  FAILED
}

enum CommandStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum InvoiceStatus {
  PAID
  PENDING
  OVERDUE
  REFUNDED
}

enum NotificationStatus {
  UNREAD
  READ
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum BookingStatus {
  RESERVED
  ACTIVE
  COMPLETED
  CANCELLED
}

model Tenant {
  id        String         @id @default(cuid())
  name      String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  orgs      Organization[]
  users     User[]
}

model Organization {
  id        String    @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  users     User[]
  stations  Station[]

  @@index([tenantId])
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  passwordHash String
  name         String
  role         Role
  tenantId     String
  orgId        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  organization Organization?  @relation(fields: [orgId], references: [id])
  refresh      RefreshToken[]
  sessions     ChargingSession[]
  notifications Notification[]

  @@index([tenantId])
  @@index([orgId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Station {
  id            String        @id @default(cuid())
  code          String        @unique
  name          String
  region        String
  country       String
  orgId         String
  type          StationType
  status        StationStatus
  healthScore   Int           @default(100)
  utilization   Int           @default(0)
  connectors    Int           @default(0)
  swapBays      Int           @default(0)
  openIncidents Int           @default(0)
  lastHeartbeat DateTime?
  address       String
  lat           Float?
  lng           Float?
  make          String?
  model         String?
  maxKw         Int?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  organization  Organization  @relation(fields: [orgId], references: [id])
  chargePoints  ChargePoint[]
  swapStations  SwapStation[]
  policies      SmartChargingPolicy[]
  bookings      Booking[]
  sessions      ChargingSession[]
  commands      CommandJob[]

  @@index([orgId])
  @@index([status])
}

model ChargePoint {
  id        String        @id @default(cuid())
  stationId String
  vendor    String?
  model     String?
  status    StationStatus @default(ONLINE)
  maxKw     Int?
  connectors Int          @default(1)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  station   Station       @relation(fields: [stationId], references: [id])
  sessions  ChargingSession[]

  @@index([stationId])
}

model SwapStation {
  id        String        @id @default(cuid())
  stationId String
  status    StationStatus @default(ONLINE)
  bays      Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  station   Station       @relation(fields: [stationId], references: [id])

  @@index([stationId])
}

model SmartChargingPolicy {
  id        String   @id @default(cuid())
  stationId String
  name      String
  active    Boolean  @default(true)
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  station   Station  @relation(fields: [stationId], references: [id])

  @@index([stationId])
}

model Booking {
  id        String        @id @default(cuid())
  stationId String
  userId    String?
  status    BookingStatus @default(RESERVED)
  startAt   DateTime
  endAt     DateTime
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  station   Station       @relation(fields: [stationId], references: [id])
}

model ChargingSession {
  id           String        @id @default(cuid())
  stationId    String
  chargePointId String?
  userId       String?
  status       SessionStatus @default(PENDING)
  startedAt    DateTime
  endedAt      DateTime?
  kwh          Float?        @default(0)
  amount       Decimal?      @default(0)
  currency     String        @default("USD")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  station      Station       @relation(fields: [stationId], references: [id])
  chargePoint  ChargePoint?  @relation(fields: [chargePointId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])
  meterValues  MeterValue[]

  @@index([stationId])
  @@index([userId])
}

model MeterValue {
  id         String          @id @default(cuid())
  sessionId  String
  recordedAt DateTime        @default(now())
  kwh        Float
  powerKw    Float?
  voltage    Float?
  current    Float?
  session    ChargingSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
}

model CommandJob {
  id        String        @id @default(cuid())
  stationId String
  command   String
  status    CommandStatus @default(QUEUED)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  station   Station       @relation(fields: [stationId], references: [id])

  @@index([stationId])
}

model Invoice {
  id        String        @id @default(cuid())
  orgId     String
  amount    Decimal
  currency  String        @default("USD")
  status    InvoiceStatus
  issuedAt  DateTime
  dueAt     DateTime
  paidAt    DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  organization Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
}

model PaymentIntent {
  id        String   @id @default(cuid())
  userId    String?
  amount    Decimal
  currency  String   @default("USD")
  status    String
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String?
  amount    Decimal
  currency  String   @default("USD")
  type      String
  status    String
  reference String?
  createdAt DateTime @default(now())
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Decimal  @default(0)
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  title     String
  body      String
  channel   NotificationChannel @default(IN_APP)
  status    NotificationStatus @default(UNREAD)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id])

  @@index([userId])
}
